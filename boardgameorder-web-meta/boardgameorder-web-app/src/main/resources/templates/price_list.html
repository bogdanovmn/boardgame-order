{{#layout}}

{{#publishers.0}}
	<div id="order">
		<div class="title">Корзина</div>
		<div class="details"></div>
		<div class="menu">
			<a href="{{layout.contextPath}}/user/order/items">Подробнее...</a>
		</div>
	</div>

	<div id="price-list">
		<h1>Все цены {{publishers.0.prices.0.source.fileModifyDate}}</h1>
		{{#publishers}}
			<div id="publisher-{{publisher.id}}" class="publisher-block">
				<b>{{publisher.normalizedName}}</b> ({{prices.size}})
				<table>
				{{#prices}}
					<tr id="item-{{item.id}}" class="price-item">
						<td class="count">{{count}}<i>шт</i></td>
						<td class="price">{{roundedPrice}}<i>р</i></td>
						<td class="action">
							<div
								class="button button-add-item"
								data-href="/user/order/items/{{item.id}}"
								data-type="add"
								data-id="{{item.id}}">+</div>
						</td>
						<td class="title" >
							{{{item.htmlTitle}}}
							<a target="_blank" href="{{item.url}}">фото</a>
						</td>
					</tr>
				{{/prices}}
				</table>
			</div>
		{{/publishers}}
	</div>
{{/publishers.0}}

{{^publishers.0}}
	<h1>Пусто</h1>
{{/publishers.0}}

<script>
	OrderBlock = function() {
		this.itemsCount = parseInt("{{order.itemsCount}}") || 0;
		this.total = parseInt("{{order.total}}") || 0;
		this.totalWithDiscount = function() {
			var x = this.total * 0.92;
			// round to 50 RUB
			y = x % 50;
			if (y > 0) {
				x = x + 50 - y;
			}
			return x;
		};

		this.addItem = function(id) {
			var item = new Item(id);
			this.total += item.getPrice();
			this.itemsCount++;
		};

		this.render = function() {
			$("#order div.details").html(
				"<p>Выбрано:<b>" + this.itemsCount + "</b><p>Сумма:<br>" + this.total + " руб.<p>Со скидкой:<br><b>" + this.totalWithDiscount() + "</b> руб."
			)
		}
	};

	Item = function(id) {
		this.id = id;
		this.getPrice = function() {
			return parseInt(
				$("#item-" + this.id + " td.price").text(),
				10
			);
		}
	};

	var blockInAction = {};
	var order = new OrderBlock();
	order.render();

	$('div.button').click(
		function() {
			var button = $(this);
			var actionUrl = "{{layout.contextPath}}" + button.attr("data-href");
			var itemId = button.attr("data-id");

			if (blockInAction[itemId]) {
				return
			}
			blockInAction[itemId] = true;

			var itemBlock = $("#item-" + itemId);
			itemBlock.toggleClass("in-action");

			switch (button.attr("data-type")) {
				case "add":
					addItem(itemId, actionUrl, "PUT");
					break;
			}

			itemBlock.toggleClass("in-action");
			blockInAction[itemId] = false;
		}
	);
	function addItem(itemId, url, method) {
		console.log("[action] " + method + " " + url);

		$.ajax({ url: url, method: method})
			.done(function(resp) {
				console.log('[OK] ' + url);
				order.addItem(itemId);
				order.render();
			})
			.fail(function (jqXHR, excpetion) {
				console.log("[ERROR] " + url + "\n" + excpetion)
			})
	}
</script>
{{/layout}}